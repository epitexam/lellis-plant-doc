@startuml
skinparam linetype ortho
skinparam componentStyle uml2
skinparam node {
    BackgroundColor White
    BorderColor Black
}

' =========================
' CLIENTS
' =========================

node "Client Devices" {
    component "Tauri Desktop App" as Desktop <<Artifact>>
    component "Web App" as WebClient <<Artifact>>
    component "Mobile App" as MobileClient <<Artifact>>

    note right of Desktop
      - React / Vue
      - Local encrypted SQLite
      - Offline-first sync
    end note

    note right of WebClient
      - SPA / SSR
      - HTTPS access
    end note

    note right of MobileClient
      - React Native / Flutter
      - Offline caching
    end note
}

cloud "Internet" as Internet

' =========================
' SERVER INFRASTRUCTURE
' =========================

node "Self-Hosted Server\n(VPS / On-Premise)" as ServerNode <<Server>> {

    node "Docker Host" <<Execution Environment>> {

        ' DMZ
        package "Public Network (DMZ)" {
            component "Reverse Proxy\n(Nginx / Traefik)" as Proxy <<Container>>
            note right of Proxy
              - TLS termination
              - Security headers
              - Optional rate limiting
            end note
        }

        ' Internal Network
        package "Private Network" {

            component "Backend API\n(Modular Monolith)" as Backend <<Container>>
            note left of Backend
              - Single deployment unit
              - Clean Architecture (Presentation / Application / Domain / Infrastructure)
              - Modules:
                * Identity
                * Security (RBAC)
                * Workspace
                * Medical Core
                * Documents
                * Audit & Notifications
              - Communication:
                * In-process calls
                * Domain Events (event bus)
              - Each module has its own PostgreSQL DB
            end note

            ' ----------------------------
            ' DATABASES (one per module)
            ' ----------------------------
            database "Identity DB (PostgreSQL)" as DBIdentity <<Container>>
            database "Workspace DB (PostgreSQL)" as DBWorkspace <<Container>>
            database "Medical DB (PostgreSQL)" as DBMedical <<Container>>
            database "Audit DB (PostgreSQL)" as DBAudit <<Container>>
            database "Documents DB (PostgreSQL)" as DBDocuments <<Container>>

            component "Object Storage\n(MinIO / S3 Compatible)" as FileStore <<Container>>

            ' ----------------------------
            ' INTERNAL DOMAIN EVENTS
            ' ----------------------------
            note right of Backend
              Example Domain Events:
              - IdentityCreated → Workspace module updates member list
              - VisitCreated → Audit module logs action
              - DocumentUploaded → Medical module notified
            end note
        }
    }

    ' -------- PERSISTENCE --------
    folder "Persistent Volumes" as Volumes {
        file "identity_pg_data" as VolDBIdentity
        file "workspace_pg_data" as VolDBWorkspace
        file "medical_pg_data" as VolDBMedical
        file "audit_pg_data" as VolDBAudit
        file "documents_pg_data" as VolDBDocuments
        file "object_storage" as VolDocs
    }
}

' =========================
' EXTERNAL SERVICES
' =========================

cloud "External Services" as External {
    component "SMTP Provider" as SMTP
    component "Health APIs\n(DMP / INS)" as MedAPI
}

' =========================
' CONNECTIONS
' =========================

Desktop --> Internet : HTTPS / WSS
WebClient --> Internet : HTTPS / WSS
MobileClient --> Internet : HTTPS / WSS
Internet --> Proxy : 443 / TLS
Proxy --> Backend : HTTP

' Backend → Databases
Backend --> DBIdentity : SQL
Backend --> DBWorkspace : SQL
Backend --> DBMedical : SQL
Backend --> DBAudit : SQL
Backend --> DBDocuments : SQL

Backend --> FileStore : S3 API
Backend --> SMTP : Async notifications
Backend --> MedAPI : Secure outbound API

' Persistence
DBIdentity ..> VolDBIdentity
DBWorkspace ..> VolDBWorkspace
DBMedical ..> VolDBMedical
DBAudit ..> VolDBAudit
DBDocuments ..> VolDBDocuments
FileStore ..> VolDocs

@enduml
