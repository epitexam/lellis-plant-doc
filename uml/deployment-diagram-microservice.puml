@startuml
!define RECTANGLE class
skinparam linetype ortho
skinparam shadowing false
skinparam nodesep 80
skinparam ranksep 80

' Styles
skinparam component {
    BackgroundColor<<Microservice>> #E3F2FD
    BorderColor<<Microservice>> #1976D2
    BackgroundColor<<Infrastructure>> #F5F5F5
    BackgroundColor<<Security>> #FFEBEE
}

' ==========================================
' ZONE CLIENTS
' ==========================================
node "Client Tier" #GhostWhite {
    component "Desktop / Web / Mobile" as Clients
}

' ==========================================
' EDGE & OBSERVABILITY
' ==========================================
package "Edge & Governance" {
    component "Nginx / Traefik" as Proxy <<Infrastructure>>
    component "API Gateway\n(Auth Validation)" as Gateway <<Infrastructure>> #Gold
    component "Monitoring Stack\n(Loki/Prometheus/Jaeger)" as Ops <<Infrastructure>> #LightGreen
}

' ==========================================
' MESSAGERIE
' ==========================================
queue "Message Broker\n(RabbitMQ / Kafka)" as Broker #LightYellow

' ==========================================
' BUSINESS SERVICES
' ==========================================
package "Business Services" {
    
    node "Identity MS" {
        component "Auth Service" as MS_Auth <<Microservice>>
        database "Identity DB" as DB_Auth
    }

    node "Medical MS" {
        component "Clinical Core" as MS_Med <<Microservice>>
        database "Medical DB" as DB_Med
    }

    node "Workspace MS" {
        component "Workspace Mgr" as MS_Work <<Microservice>>
        database "Workspace DB" as DB_Work
    }

    node "Storage MS" {
        component "Doc Service" as MS_Doc <<Microservice>>
        database "Doc Metadata" as DB_Doc
    }

    node "Audit MS" {
        component "Audit Logger" as MS_Audit <<Microservice>>
        database "Audit DB" as DB_Audit
    }
}

' ==========================================
' EXTERNAL & PERSISTENCE
' ==========================================
cloud "External Services" {
    [S3 / MinIO Storage] as S3
    [Health APIs (DMP/INS)] as MedAPI
}

' ==========================================
' FLUX DE COMMUNICATION
' ==========================================

' Entrée et Auth
Clients --> Proxy : HTTPS (JWT)
Proxy --> Gateway
Gateway .right.> MS_Auth : 1. Validate Token
Gateway --> MS_Med : 2. Authorized Request

' Communication Asynchrone (Event-Driven)
MS_Auth -[#blue]down-> Broker : "UserCreated"
MS_Med -[#blue]down-> Broker : "MedicalEvent"
MS_Doc -[#blue]down-> Broker : "FileUploaded"

Broker -[#red]up-> MS_Work : Consume
Broker -[#red]up-> MS_Audit : Consume

' Gestion des fichiers (Optimisée)
MS_Doc -- S3 : Generate Presigned URL
Clients <--> S3 : Direct Upload/Download

' Observabilité (Télémétrie)
MS_Auth -- Ops
MS_Med -- Ops
MS_Doc -- Ops

' Dépendances
MS_Med --> MedAPI

@enduml