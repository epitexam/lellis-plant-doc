@startuml
skinparam classAttributeIconSize 0
skinparam linetype ortho
skinparam packageStyle frame
skinparam nodesep 60
skinparam ranksep 60

' =========================
' SECURITY CORE + ABAC â€“ PHASE 2
' =========================
package "Security Core (RBAC + ABAC)" #F9F9F9 {

    class Role <<Aggregate>> {
        +id: RoleId
        +name: string
        +description: string
        +scope: RoleScope
        +isSystem: boolean
        --
        +can(permission: PermissionCode): boolean
        +grantPermission(permission: Permission): void
        +revokePermission(permissionCode: PermissionCode): void
        +listPermissions(): Permission[]
    }

    class Permission <<Entity>> {
        +id: PermissionId
        +code: PermissionCode <<VO>>
        +label: string
        +category: PermissionCategory
    }

    Role "1" *-- "0..*" Permission : grants >
}

package "Authorization" #FFF3D6 {

    class AuthorizationService <<Domain Service>> {
        +can(userId: UserId, permission: PermissionCode, context?: AuthorizationContext): boolean
    }

    class AuthorizationContext <<ValueObject>> {
        +workspaceId?: WorkspaceId
        +resourceType?: string
        +resourceId?: string
        +requestedAt: DateTime
        +attributes: Map<string, any>
    }

    class Policy <<Aggregate>> {
        +id: PolicyId
        +name: string
        --
        +evaluate(context: AuthorizationContext): boolean
    }

    class Rule <<Entity>> {
        +id: RuleId
        +effect: Allow | Deny
        --
        +evaluate(context: AuthorizationContext): boolean
    }

    class Condition <<ValueObject>> {
        +type: string
        +parameters: Map<string, any>
        --
        +matches(context: AuthorizationContext): boolean
    }

    Policy "1" *-- "1..*" Rule
    Rule "1" *-- "1..*" Condition
    AuthorizationService ..> Policy
    AuthorizationService ..> Role
}

package "Identity Management" #EEE {

    class User <<Aggregate>> {
        +id: UserId
        +email: Email
        +status: UserStatus
        --
        +isActive(): boolean
        +assignGlobalRole(role: Role): void
        +revokeGlobalRole(roleId: RoleId): void
        +listGlobalRoles(): Role[]
    }

    class UserGlobalRole <<Aggregate>> {
        +id: UserGlobalRoleId
        +assignedAt: DateTime
        --
        +roleId: RoleId
    }

    class Session <<Entity>> {
        +id: SessionId
        +token: string
        +deviceInfo: string
        +expiresAt: DateTime
    }

    User "1" *-- "0..*" UserGlobalRole
    UserGlobalRole "1" --> "1" Role
    User "1" *-- "0..*" Session
}

package "Workspace Management" #E6F3FF {

    class Workspace <<Aggregate>> {
        +id: WorkspaceId
        +name: string
        +slug: string
        +createdAt: DateTime
    }

    class WorkspaceMember <<Aggregate>> {
        +id: WorkspaceMemberId
        +userId: UserId
        +workspaceId: WorkspaceId
        +status: MemberStatus
        +joinedAt: DateTime
        --
        +assignRole(role: Role): void
        +revokeRole(roleId: RoleId): void
        +hasAccess(permission: PermissionCode, context?: AuthorizationContext): boolean
        +listRoles(): Role[]
    }

    Workspace "1" *-- "0..*" WorkspaceMember
    User "1" --> "0..*" WorkspaceMember
    WorkspaceMember "1" o-- "0..*" Role : assigned (WORKSPACE)
}

package "Events" #F2F2F2 {

    class DomainEvent <<Event>> {
        +occurredAt: DateTime
    }

    class RoleAssigned <<Event>>
    class RoleRevoked <<Event>>
    class UserGlobalRoleAssigned <<Event>>
    class WorkspaceMemberCreated <<Event>>
    class PolicyCreated <<Event>>
    class RuleEvaluated <<Event>>

    DomainEvent <|-- RoleAssigned
    DomainEvent <|-- RoleRevoked
    DomainEvent <|-- UserGlobalRoleAssigned
    DomainEvent <|-- WorkspaceMemberCreated
    DomainEvent <|-- PolicyCreated
    DomainEvent <|-- RuleEvaluated
}

package "Audit & Notification" #D4F0D4 {

    class AuditLog <<Entity>> {
        +id: AuditLogId
        +action: string
        +entityType: string
        +entityId: string
        +performedBy: UserId
        +occurredAt: DateTime
    }

    class Notification <<Entity>> {
        +id: NotificationId
        +title: string
        +message: string
        +isRead: boolean
    }

    User "1" *-- "0..*" Notification
}

@enduml
